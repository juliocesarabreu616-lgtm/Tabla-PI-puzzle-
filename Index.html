<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Puzzle Lógico P / I</title>

  <!-- CSS -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div id="app">

  <!-- HEADER -->
  <header>
    <h1>Puzzle Lógico</h1>
    <div class="level">Nivel 1</div>
  </header>

  <!-- INFO -->
  <div class="info-bar">
    <div class="info-box">⏱ <span id="time">30</span>s</div>
    <div class="info-box">⭐ <span id="score">0</span></div>
  </div>

  <!-- PUZZLE -->
  <div id="puzzle" class="puzzle"></div>

  <!-- ACCIONES -->
  <div class="actions">
    <button class="secondary" onclick="newPuzzle()">Reiniciar</button>
    <button class="primary" onclick="check()">Comprobar</button>
  </div>

  <!-- MENSAJE -->
  <div class="message" id="message"></div>

  <!-- ZONA DE ANUNCIO -->
  <div class="ad-zone">
    Zona reservada para anuncios
  </div>

</div>

<!-- MOTOR -->
<script src="game.js"></script>

<script>
/* ===============================
   CONEXIÓN UI ↔ MOTOR
================================ */

let currentPuzzle;
let timer;
let timeLeft = GameEngine.state.timeLimit;

/* ===============================
   INICIAR PUZZLE
================================ */

function newPuzzle() {
  currentPuzzle = GameEngine.newPuzzle();
  renderPuzzle();
  resetTimer();
  document.getElementById("message").textContent = "";
}

/* ===============================
   RENDER PUZZLE
================================ */

function renderPuzzle() {
  const container = document.getElementById("puzzle");
  container.innerHTML = "";

  // Celda vacía superior izquierda
  container.appendChild(cell("", "empty"));

  // Headers fila
  currentPuzzle.headersRow.forEach(h => {
    container.appendChild(cell(h, "header"));
  });

  // Filas
  currentPuzzle.headersCol.forEach((h, r) => {
    container.appendChild(cell(h, "header"));

    currentPuzzle.playerGrid[r].forEach((val, c) => {
      if (val === null) {
        container.appendChild(inputCell(r, c));
      } else {
        container.appendChild(cell(val));
      }
    });
  });
}

/* ===============================
   CELDAS
================================ */

function cell(text, type = "") {
  const div = document.createElement("div");
  div.className = "cell " + type;
  div.textContent = text;
  return div;
}

function inputCell(r, c) {
  const div = document.createElement("div");
  div.className = "cell";

  const btn = document.createElement("button");
  btn.textContent = "?";

  btn.onclick = () => {
    btn.textContent = btn.textContent === "P" ? "I" : "P";
  };

  btn.dataset.r = r;
  btn.dataset.c = c;

  div.appendChild(btn);
  return div;
}

/* ===============================
   COMPROBAR SOLUCIÓN
================================ */

function check() {
  const inputs = document.querySelectorAll(".cell button");

  const grid = JSON.parse(JSON.stringify(currentPuzzle.playerGrid));

  inputs.forEach(btn => {
    const r = btn.dataset.r;
    const c = btn.dataset.c;
    grid[r][c] = btn.textContent;
  });

  const ok = GameEngine.checkSolution(currentPuzzle, grid);

  document.getElementById("score").textContent = GameEngine.state.score;
  document.getElementById("message").textContent = ok
    ? "✅ Correcto"
    : "❌ Intenta de nuevo";

  if (ok) {
    newPuzzle();
  }
}

/* ===============================
   TEMPORIZADOR
================================ */

function resetTimer() {
  clearInterval(timer);
  timeLeft = GameEngine.state.timeLimit;
  document.getElementById("time").textContent = timeLeft;

  timer = setInterval(() => {
    timeLeft--;
    document.getElementById("time").textContent = timeLeft;

    if (timeLeft <= 0) {
      clearInterval(timer);
      document.getElementById("message").textContent =
        "⏰ Tiempo terminado. Se reinicia el puzzle.";
      newPuzzle();
    }
  }, 1000);
}

/* ===============================
   INICIO
================================ */

newPuzzle();
</script>

</body>
</html>
